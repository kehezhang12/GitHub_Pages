---
title: "Mapping ACS data at county level"
date: "`r format(Sys.time(), '%B %d, %Y')`"
author: Kehe Zhang
output:
  html_notebook:
    toc: yes
---

This R markdown template includes:
1. Data query from US Census American Community Survey       
2. Summary statistics table             
3. Mapping using tmap and ggplot            


```{r setup and load packages}
rm(list=ls())
# set up the knitting options 
# echo=T will display the codes, warning=F will not display warning messages from R 
knitr::opts_chunk$set(echo =T, warning = F, messages=F)


# Package names
packages <- c(
  "ggplot2", # mapping
  "stringi",
  "tidyverse", # data manipulation
  "tigris", # query shapefiles for mapping
  "tidycensus", # query data from US census
  "tmap", # mapping
  "ggcorrplot" # correlation plots
  )

# Install packages not yet installed
installed_packages <- packages %in% rownames(installed.packages())
if (any(installed_packages == FALSE)) {
  install.packages(packages[!installed_packages])
}

# Packages loading
invisible(lapply(packages, library, character.only = TRUE))

```


## Query and Process Data

### ACS data     
```{r,warning=F, message=F}
# load table summarizing available variables
acs19 <- load_variables(year= 2019, dataset="acs5/profile")
# 2019 ACS data for all Texas counties - total population, Per capita income and % unemployed
TX_county_dt <- get_acs(geography = "county", state="TX", variables=c("B01001_001", "B19301_001", "DP03_0005P","DP03_0119P"), year=2019) ##geometry=T will give you the shapefiles
# format the data 
TX_county_dt <- TX_county_dt[,1:4] %>%  
   tidyr::spread(key="variable", value="estimate") %>% 
   rename(Population=B01001_001, Per_capita_income=B19301_001, Unemployment=DP03_0005P, Poverty=DP03_0119P)

```

### County shapefiles      
```{r message=F, results='hide'}
## Get county shapefiles
library(tigris) # more info about tigris package: https://rpubs.com/walkerke/tigris01
TX_county_shp <- counties(state="TX", year=2019, cb=T) # or you can read in local files using readOGR()
# You can subset shapefiles for a specific county: for example Harris County
Harris_county_shp <- subset(TX_county_shp, TX_county_shp$NAME == "Harris")

```

## Data Summary 

### Summary Table
"table1" package is useful to create summary statistics table: https://cran.r-project.org/web/packages/table1/vignettes/table1-examples.html                
```{r}
library(table1)
table1(~ Population+ Per_capita_income + Unemployment, data=TX_county_dt)
```


### Correlation Matrix 
```{r}
cor <- cor(TX_county_dt[,3:5], method = "pearson", use = "complete.obs")
cor <- as.data.frame(round(cor,2))
# rename variables
names(cor) <- c("Population", "Per capita income", "Unemployment")
row.names(cor) <-  c("Population", "Per capita income", "Unemployment")
#add correlation coefficients & reorder matrix using hierarchical clustering
ggcorrplot(cor,  type = "lower",lab = TRUE)

```


## Mapping County Level Population Data

### ggplot method 1
```{r}
############################
### Using ggplot2 Method 1
############################
library(ggplot2) # more about mapping in ggplot: http://mazamascience.com/WorkingWithData/?p=1494
# merge with data
TX_county_shp1 <- merge(TX_county_shp, TX_county_dt, by="GEOID")
# map
library(scales)
map1 <- ggplot(TX_county_shp1)+
  geom_sf(aes(fill=Population), color="grey60", alpha=0.8)+ # specify variable to map
  scale_fill_distiller(palette = "YlOrRd",na.value = "grey50", breaks = pretty_breaks(n = 6), label=comma,
                       values = c(1,0), guide=guide_colorbar(reverse = TRUE))+
  #geom_point(data=text, lat=lat, long=long)+ #can add point data here!
  labs(fill="")+xlab("Longitude")+ylab("Latitude")+
  ggtitle("Map of Texas County level Population")
map1 #check

```

### ggplot method 2
```{r fig.height=6, fig.width=14}
############################
### Using ggplot2 Method 2
############################
# convert it to SpatialPolygonDataFrame
TX_county_shp2 <- as(TX_county_shp , "Spatial")

# first convert the SpatialPolygonDataFrame to ggplot object 
ggSHP <- fortify(TX_county_shp2, region="GEOID")
# Merge data with shapefiles
ggSHP2 <- left_join(ggSHP, TX_county_dt, by=c("id"="GEOID"))

# Optional: if you would like to add Google map as the background
#library(ggmap)
#register_google(key="AIzaSyA4h-W7Ie8An3EnYx3a_LadnKrVUUKLDfs", write=TRUE) # you will need to insert your own Google API key 
#geocode("Texas") #get center coordinates of Texas
#GoogleMap <- ggmap(get_googlemap(center=c(-99.9, 32.0), scale=2 ,zoom=6, maptype = "roadmap"), extent="panel")

# mapping county level population
map2 <- #GoogleMap + #optional 
  ggplot(data=ggSHP2)+
  geom_polygon(aes(x=long, y=lat, group=group, fill=Poverty), color="grey60", alpha=0.8)+ # specify variable to map
  scale_fill_distiller(palette = "YlOrRd",na.value = "grey50", breaks = pretty_breaks(n = 3), label=comma,
                       values = c(1,0), guide=guide_colorbar(reverse = TRUE))+
  labs(fill="% Poverty")+xlab("Longitude")+ylab("Latitude")+
  ggtitle("Map of Texas County level Poverty Rate")
#map2  #check

# Put several maps together
library(ggpubr)
figure1 <- ggarrange(map1, map2)
figure1
#save the maps
#ggsave("county_tmap_ggplot.png", figure1)
  
```


### tmap
```{r fig.height=6, fig.width=12}
########################
### Using tmap
#######################
library(tmap)
# more tmap styles info here: https://geocompr.github.io/post/2019/tmap-color-scales/
map3 <- tm_shape(TX_county_shp1)+
  tm_polygons(col=c("Unemployment","Per_capita_income"), style="quantile",n=4, # specify variables and styles of mapping 
              title=c("Unemployment","Dollars"), palette="seq", lwd=0.5,  border.alpha = 0.3,midpoint=NA)+
  tm_facets(ncol=2)+ # number of columns
  tm_layout(aes.palette = list(seq = "YlOrRd"))+ # color
  tm_layout(inner.margin=c(0,0.01,0,0), # layout of the map
            legend.text.size = 0.75,
            legend.title.size = 0.75,
            legend.position=c("left", "bottom"), 
            panel.labels=c("Unemployment","Per capita income"),
            panel.label.bg.color = "White")
  #tm_text(data=text, lat=lat, long=long, size=1)

map3 #check
# save the map
#tmap_save(map3, filename="county_map_tmap", dpi=500)  
  
```

